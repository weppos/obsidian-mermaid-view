var f=Object.defineProperty;var M=Object.getOwnPropertyDescriptor;var T=Object.getOwnPropertyNames;var x=Object.prototype.hasOwnProperty;var b=(r,i)=>{for(var e in i)f(r,e,{get:i[e],enumerable:!0})},S=(r,i,e,t)=>{if(i&&typeof i=="object"||typeof i=="function")for(let s of T(i))!x.call(r,s)&&s!==e&&f(r,s,{get:()=>i[s],enumerable:!(t=M(i,s))||t.enumerable});return r};var P=r=>S(f({},"__esModule",{value:!0}),r);var L={};b(L,{default:()=>u});module.exports=P(L);var w=require("obsidian");var d=require("obsidian"),a=require("@codemirror/view"),E=require("@codemirror/state"),p=require("@codemirror/commands"),v="mermaid-view",h=class extends d.TextFileView{constructor(e,t){super(e);this.mode="preview";this.scale=1;this.translateX=0;this.translateY=0;this.isPanning=!1;this.startX=0;this.startY=0;this.MIN_SCALE=.1;this.MAX_SCALE=5;this.renderDebounceTimer=null;this.RENDER_DEBOUNCE_MS=300;this.plugin=t}getViewType(){return v}getDisplayText(){var e,t;return(t=(e=this.file)==null?void 0:e.basename)!=null?t:"Mermaid Diagram"}getIcon(){return"git-branch"}async onOpen(){let e=this.contentEl;e.empty(),e.addClass("mermaid-view-container"),this.previewEl=e.createDiv({cls:"mermaid-view-preview"}),this.zoomWrapper=this.previewEl.createDiv({cls:"mermaid-zoom-wrapper"}),this.setupPanZoom(),this.sourceEl=e.createDiv({cls:"mermaid-view-source"}),this.editorView=new a.EditorView({state:E.EditorState.create({doc:"",extensions:[(0,a.lineNumbers)(),(0,a.highlightActiveLine)(),(0,a.drawSelection)(),(0,p.history)(),a.keymap.of([...p.defaultKeymap,...p.historyKeymap]),a.EditorView.updateListener.of(t=>{t.docChanged&&(this.data=t.state.doc.toString(),this.requestSave(),this.mode==="split"&&this.debouncedRenderPreview())}),a.EditorView.theme({"&":{height:"100%",backgroundColor:"var(--background-primary)"},".cm-scroller":{fontFamily:"var(--font-monospace)",fontSize:"var(--font-text-size)",overflow:"auto"},".cm-content":{caretColor:"var(--text-normal)"},".cm-gutters":{backgroundColor:"var(--background-secondary)",color:"var(--text-muted)",border:"none"},".cm-activeLineGutter":{backgroundColor:"var(--background-modifier-hover)"},".cm-activeLine":{backgroundColor:"var(--background-modifier-hover)"}})]}),parent:this.sourceEl}),this.addAction("code","Toggle source/preview",()=>{this.toggleMode()}),this.addAction("maximize","Reset zoom",()=>{this.resetZoom()}),this.setMode("preview")}async onClose(){this.editorView.destroy(),this.contentEl.empty()}getViewData(){return this.data}setViewData(e,t){this.data=e,this.editorView.dispatch({changes:{from:0,to:this.editorView.state.doc.length,insert:e}}),(this.mode==="preview"||this.mode==="split")&&this.renderPreview()}clear(){this.data="",this.editorView.dispatch({changes:{from:0,to:this.editorView.state.doc.length,insert:""}}),this.previewEl.empty()}setMode(e){var s;this.mode=e,this.contentEl.removeClass("mermaid-mode-preview","mermaid-mode-split","mermaid-mode-source","mermaid-layout-editor-left","mermaid-layout-editor-right"),this.contentEl.addClass(`mermaid-mode-${e}`),e==="preview"?(this.sourceEl.hide(),this.previewEl.show(),this.renderPreview()):e==="split"?(this.contentEl.addClass(`mermaid-layout-${this.plugin.settings.splitLayout}`),this.sourceEl.show(),this.previewEl.show(),this.renderPreview()):(this.previewEl.hide(),this.sourceEl.show(),this.editorView.focus());let t=(s=this.contentEl.parentElement)==null?void 0:s.querySelector('.view-action[aria-label^="Toggle"]');t&&(t.empty(),(0,d.setIcon)(t,e==="preview"?"columns":e==="split"?"code":"eye"),t.setAttribute("aria-label",`Toggle view mode (${e})`))}toggleMode(){let e=this.mode==="preview"?"split":this.mode==="split"?"source":"preview";this.setMode(e)}debouncedRenderPreview(){this.renderDebounceTimer!==null&&window.clearTimeout(this.renderDebounceTimer),this.renderDebounceTimer=window.setTimeout(()=>{this.renderDebounceTimer=null,this.renderPreview(!0)},this.RENDER_DEBOUNCE_MS)}async renderPreview(e=!1){var l,n;this.zoomWrapper.empty(),e||this.resetZoom();let t=this.data.trim();if(!t){this.zoomWrapper.createDiv({cls:"mermaid-view-empty",text:"Empty diagram. Switch to source mode to add content."});return}let s=this.zoomWrapper.createDiv(),o="```mermaid\n"+t+"\n```";try{await d.MarkdownRenderer.render(this.app,o,s,(n=(l=this.file)==null?void 0:l.path)!=null?n:"",this)}catch(m){this.zoomWrapper.empty(),this.zoomWrapper.createDiv({cls:"mermaid-view-error",text:`Error rendering diagram:
${m}`})}}setupPanZoom(){this.previewEl.addEventListener("wheel",e=>{e.preventDefault();let t=this.previewEl.getBoundingClientRect(),s=e.clientX-t.left,o=e.clientY-t.top,l=e.deltaY>0?.9:1.1,n=Math.min(this.MAX_SCALE,Math.max(this.MIN_SCALE,this.scale*l)),m=n/this.scale;this.translateX=s-m*(s-this.translateX),this.translateY=o-m*(o-this.translateY),this.scale=n,this.applyTransform()}),this.previewEl.addEventListener("mousedown",e=>{e.button===0&&(this.isPanning=!0,this.startX=e.clientX-this.translateX,this.startY=e.clientY-this.translateY,this.previewEl.addClass("mermaid-view-panning"))}),this.previewEl.addEventListener("mousemove",e=>{this.isPanning&&(this.translateX=e.clientX-this.startX,this.translateY=e.clientY-this.startY,this.applyTransform())}),this.previewEl.addEventListener("mouseup",()=>{this.isPanning=!1,this.previewEl.removeClass("mermaid-view-panning")}),this.previewEl.addEventListener("mouseleave",()=>{this.isPanning=!1,this.previewEl.removeClass("mermaid-view-panning")}),this.previewEl.addEventListener("dblclick",()=>{this.resetZoom()})}applyTransform(){this.zoomWrapper.style.transform=`translate(${this.translateX}px, ${this.translateY}px) scale(${this.scale})`}resetZoom(){this.scale=1,this.translateX=0,this.translateY=0,this.applyTransform()}};var c=require("obsidian"),y={extensions:["mermaid","mmd"],splitLayout:"editor-left"};function V(r){return r.split(",").map(i=>i.trim().toLowerCase()).filter(i=>i.length>0)}var g=class extends c.PluginSettingTab{constructor(i,e){super(i,e),this.plugin=e}display(){let{containerEl:i}=this;i.empty(),new c.Setting(i).setName("File extensions").setDesc("Comma-separated list of file extensions to treat as Mermaid files (without the dot). Changes require restarting Obsidian.").addText(e=>e.setPlaceholder("mermaid, mmd").setValue(this.plugin.settings.extensions.join(", ")).onChange(async t=>{this.plugin.settings.extensions=V(t),await this.plugin.saveSettings()})),i.createEl("p",{text:"Note: After changing extensions, you need to restart Obsidian for the changes to take effect.",cls:"setting-item-description"}),new c.Setting(i).setName("Split view layout").setDesc("Choose the position of the editor and preview in split mode.").addDropdown(e=>e.addOption("editor-left","Editor left, preview right").addOption("editor-right","Editor right, preview left").setValue(this.plugin.settings.splitLayout).onChange(async t=>{this.plugin.settings.splitLayout=t,await this.plugin.saveSettings()}))}};var u=class extends w.Plugin{async onload(){await this.loadSettings(),this.registerView(v,i=>new h(i,this)),this.registerExtensions(this.settings.extensions,v),this.addSettingTab(new g(this.app,this)),this.addCommand({id:"toggle-mermaid-mode",name:"Toggle source/preview mode",checkCallback:i=>{let e=this.app.workspace.getActiveViewOfType(h);return e?(i||e.toggleMode(),!0):!1}}),this.registerEvent(this.app.workspace.on("file-menu",(i,e)=>{let t=e instanceof w.TFolder?e:e.parent;t&&i.addItem(s=>{s.setTitle("New mermaid").setIcon("diamond").onClick(()=>this.createMermaidFile(t))})}))}async createMermaidFile(i){let e=this.settings.extensions[0]||"mermaid",t="Untitled",s=`${t}.${e}`,o=1;for(;this.app.vault.getAbstractFileByPath(`${i.path}/${s}`);)s=`${t} ${o}.${e}`,o++;let l=i.path==="/"?s:`${i.path}/${s}`,n=await this.app.vault.create(l,"");await this.app.workspace.getLeaf().openFile(n)}onunload(){}async loadSettings(){this.settings=Object.assign({},y,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}};
