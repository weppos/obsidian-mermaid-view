var u=Object.defineProperty;var g=Object.getOwnPropertyDescriptor;var f=Object.getOwnPropertyNames;var y=Object.prototype.hasOwnProperty;var M=(r,t)=>{for(var e in t)u(r,e,{get:t[e],enumerable:!0})},T=(r,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of f(t))!y.call(r,s)&&s!==e&&u(r,s,{get:()=>t[s],enumerable:!(i=g(t,s))||i.enumerable});return r};var x=r=>T(u({},"__esModule",{value:!0}),r);var P={};M(P,{default:()=>c});module.exports=x(P);var v=require("obsidian");var l=require("obsidian"),h="mermaid-view",d=class extends l.TextFileView{constructor(e,i){super(e);this.mode="preview";this.scale=1;this.translateX=0;this.translateY=0;this.isPanning=!1;this.startX=0;this.startY=0;this.MIN_SCALE=.1;this.MAX_SCALE=5;this.renderDebounceTimer=null;this.RENDER_DEBOUNCE_MS=300;this.plugin=i}getViewType(){return h}getDisplayText(){var e,i;return(i=(e=this.file)==null?void 0:e.basename)!=null?i:"Mermaid Diagram"}getIcon(){return"git-branch"}async onOpen(){let e=this.contentEl;e.empty(),e.addClass("mermaid-view-container"),this.previewEl=e.createDiv({cls:"mermaid-view-preview"}),this.zoomWrapper=this.previewEl.createDiv({cls:"mermaid-zoom-wrapper"}),this.setupPanZoom(),this.sourceEl=e.createDiv({cls:"mermaid-view-source"}),this.editorEl=this.sourceEl.createEl("textarea"),this.editorEl.addClass("mermaid-view-editor"),this.editorEl.spellcheck=!1,this.editorEl.style.width="100%",this.editorEl.style.height="100%",this.editorEl.style.resize="none",this.editorEl.style.border="none",this.editorEl.style.outline="none",this.editorEl.style.padding="20px",this.editorEl.style.fontFamily="var(--font-monospace)",this.editorEl.style.fontSize="var(--font-text-size)",this.editorEl.style.backgroundColor="var(--background-primary)",this.editorEl.style.color="var(--text-normal)",this.editorEl.style.boxSizing="border-box",this.editorEl.addEventListener("input",()=>{this.data=this.editorEl.value,this.requestSave(),this.mode==="split"&&this.debouncedRenderPreview()}),this.addAction("code","Toggle source/preview",()=>{this.toggleMode()}),this.addAction("maximize","Reset zoom",()=>{this.resetZoom()}),this.setMode("preview")}async onClose(){this.contentEl.empty()}getViewData(){return this.data}setViewData(e,i){this.data=e,this.editorEl.value=e,(this.mode==="preview"||this.mode==="split")&&this.renderPreview()}clear(){this.data="",this.editorEl.value="",this.previewEl.empty()}setMode(e){var s;this.mode=e,this.contentEl.removeClass("mermaid-mode-preview","mermaid-mode-split","mermaid-mode-source"),this.contentEl.addClass(`mermaid-mode-${e}`),e==="preview"?(this.sourceEl.hide(),this.previewEl.show(),this.renderPreview()):e==="split"?(this.sourceEl.show(),this.previewEl.show(),this.editorEl.value=this.data,this.renderPreview()):(this.previewEl.hide(),this.sourceEl.show(),this.editorEl.value=this.data,this.editorEl.focus());let i=(s=this.contentEl.parentElement)==null?void 0:s.querySelector('.view-action[aria-label^="Toggle"]');i&&(i.empty(),(0,l.setIcon)(i,e==="preview"?"columns":e==="split"?"code":"eye"),i.setAttribute("aria-label",`Toggle view mode (${e})`))}toggleMode(){let e=this.mode==="preview"?"split":this.mode==="split"?"source":"preview";this.setMode(e)}debouncedRenderPreview(){this.renderDebounceTimer!==null&&window.clearTimeout(this.renderDebounceTimer),this.renderDebounceTimer=window.setTimeout(()=>{this.renderDebounceTimer=null,this.renderPreview()},this.RENDER_DEBOUNCE_MS)}async renderPreview(){var a,n;this.zoomWrapper.empty(),this.resetZoom();let e=this.data.trim();if(!e){this.zoomWrapper.createDiv({cls:"mermaid-view-empty",text:"Empty diagram. Switch to source mode to add content."});return}let i=this.zoomWrapper.createDiv(),s="```mermaid\n"+e+"\n```";try{await l.MarkdownRenderer.render(this.app,s,i,(n=(a=this.file)==null?void 0:a.path)!=null?n:"",this)}catch(o){this.zoomWrapper.empty(),this.zoomWrapper.createDiv({cls:"mermaid-view-error",text:`Error rendering diagram:
${o}`})}}setupPanZoom(){this.previewEl.addEventListener("wheel",e=>{e.preventDefault();let i=this.previewEl.getBoundingClientRect(),s=e.clientX-i.left,a=e.clientY-i.top,n=e.deltaY>0?.9:1.1,o=Math.min(this.MAX_SCALE,Math.max(this.MIN_SCALE,this.scale*n)),w=o/this.scale;this.translateX=s-w*(s-this.translateX),this.translateY=a-w*(a-this.translateY),this.scale=o,this.applyTransform()}),this.previewEl.addEventListener("mousedown",e=>{e.button===0&&(this.isPanning=!0,this.startX=e.clientX-this.translateX,this.startY=e.clientY-this.translateY,this.previewEl.addClass("mermaid-view-panning"))}),this.previewEl.addEventListener("mousemove",e=>{this.isPanning&&(this.translateX=e.clientX-this.startX,this.translateY=e.clientY-this.startY,this.applyTransform())}),this.previewEl.addEventListener("mouseup",()=>{this.isPanning=!1,this.previewEl.removeClass("mermaid-view-panning")}),this.previewEl.addEventListener("mouseleave",()=>{this.isPanning=!1,this.previewEl.removeClass("mermaid-view-panning")}),this.previewEl.addEventListener("dblclick",()=>{this.resetZoom()})}applyTransform(){this.zoomWrapper.style.transform=`translate(${this.translateX}px, ${this.translateY}px) scale(${this.scale})`}resetZoom(){this.scale=1,this.translateX=0,this.translateY=0,this.applyTransform()}};var m=require("obsidian"),E={extensions:["mermaid","mmd"]};function b(r){return r.split(",").map(t=>t.trim().toLowerCase()).filter(t=>t.length>0)}var p=class extends m.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),new m.Setting(t).setName("File extensions").setDesc("Comma-separated list of file extensions to treat as Mermaid files (without the dot). Changes require restarting Obsidian.").addText(e=>e.setPlaceholder("mermaid, mmd").setValue(this.plugin.settings.extensions.join(", ")).onChange(async i=>{this.plugin.settings.extensions=b(i),await this.plugin.saveSettings()})),t.createEl("p",{text:"Note: After changing extensions, you need to restart Obsidian for the changes to take effect.",cls:"setting-item-description"})}};var c=class extends v.Plugin{async onload(){await this.loadSettings(),this.registerView(h,t=>new d(t,this)),this.registerExtensions(this.settings.extensions,h),this.addSettingTab(new p(this.app,this)),this.addCommand({id:"toggle-mermaid-mode",name:"Toggle source/preview mode",checkCallback:t=>{let e=this.app.workspace.getActiveViewOfType(d);return e?(t||e.toggleMode(),!0):!1}}),this.registerEvent(this.app.workspace.on("file-menu",(t,e)=>{let i=e instanceof v.TFolder?e:e.parent;i&&t.addItem(s=>{s.setTitle("New mermaid").setIcon("diamond").onClick(()=>this.createMermaidFile(i))})}))}async createMermaidFile(t){let e=this.settings.extensions[0]||"mermaid",i="Untitled",s=`${i}.${e}`,a=1;for(;this.app.vault.getAbstractFileByPath(`${t.path}/${s}`);)s=`${i} ${a}.${e}`,a++;let n=t.path==="/"?s:`${t.path}/${s}`,o=await this.app.vault.create(n,"");await this.app.workspace.getLeaf().openFile(o)}onunload(){}async loadSettings(){this.settings=Object.assign({},E,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}};
